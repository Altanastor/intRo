library(shiny)
library(ggplot2)
library(dplyr)
library(ggvis)
library(shinyAce)
library(YaleToolkit)
library(lubridate)
library(gridExtra)

numericNames <- function(data) {
    return(as.character(subset(whatis(data), type == "numeric")$variable.name))
}

categoricNames <- function(data) {
    return(names(data)[!(names(data) %in% numericNames(data))])
}

my.summary <- function(x) {
    return(c(summary(x), "SD" = sd(x, na.rm = TRUE)))
}

shinyServer(function(input, output, session) {
    
    textStorage <- paste("### Code generated by intRo on", today(), "\n\n")
    values <- reactiveValues(firstrun = TRUE)
    
    sourceDir <- function(path, ...) { for (nm in list.files(path, pattern = "\\.[Rr]$")) { source(file.path(path, nm), ...) } }
    sourceDir("modules")
    valid.trans <- list(I = I, log = log, sqrt = sqrt)
    valid.datasets <- list(mpg = mpg, airquality = airquality, diamonds = diamonds)
    valid.plottypes <- list(scatterplot = scatterplot, linechart = linechart,
                            histogram = histogram,
                            boxplot = boxplot, barchart = barchart,
                            paretochart = paretochart,
                            quantileplot = quantileplot,
                            mosaicplot = mosaicplot)
    valid.bartypes <- list(length = length, sum = sum, mean = mean, median = median)
    
    checkVariable <- function(data, var) {
        return(nchar(var) > 0 & var %in% names(data))
    }
    
    observe({
        curdata <- intro.data()
        curx <- input$var_trans
        
        if (checkVariable(curdata, curx) & (curx %in% numericNames(curdata))) {
            trans_x <- if (is.na(input$power) | input$trans == "I") curdata[,curx] else if (input$power == 0) log(curdata[,curx]) else (curdata[,curx])^(input$power)
            curdata[, paste(curx, ifelse(is.na(input$power) | input$trans == "I", "none", input$power), sep = "_")] <- as.numeric(trans_x)
            
            plot_var_trans(curdata, paste(curx, ifelse(is.na(input$power) | input$trans == "I", "none", input$power), sep = "_")) %>% bind_shiny("trans_plot")
            plot_var_trans(curdata, curx) %>% bind_shiny("var_plot")
        }
    })
    
    observe({
        curdata <- intro.data()
        curx <- input$x
        cury <- input$y
        binwidth <- input$binwidth
        addy <- input$addy
        
        if (checkVariable(curdata, curx) & (checkVariable(curdata, cury) | !addy) & input$plottype != "mosaicplot") {
            chosen.plot()(curdata, curx, cury, chosen.bartype(), binwidth, addy, input$xmin, input$xmax, input$ymin, input$ymax) %>% bind_shiny("plot")
        }
    })
    
    observe({
        curdata <- intro.data()
        curxreg <- input$xreg
        curyreg <- input$yreg
                        
        if (curxreg %in% names(curdata) & curyreg %in% names(curdata)) {
            scatterplotreg(curdata, input$xreg, input$yreg) %>% bind_shiny("regplot")
            residualreg1(intro.data(), curxreg, curyreg) %>% bind_shiny("resplot1")
            residualreg2(intro.data(), curxreg, curyreg) %>% bind_shiny("resplot2")
            residualreg3(intro.data(), curxreg, curyreg) %>% bind_shiny("resplot3")
        }
    })
    
    observe({
        updateSelectInput(session, "var_trans", choices = names(intro.data()), selected = ifelse(checkVariable(intro.data(), input$var_trans), input$var_trans, names(intro.data())[1]))
        if (input$var_trans %in% numericNames(intro.data())) updateRadioButtons(session, "trans", choices = c("None" = "I", "Type" = "type", "Power" = "power")) else updateRadioButtons(session, "trans", choices = c("None" = "I", "Type" = "type"))
        if (input$plottype %in% c("boxplot", "barchart", "paretochart", "mosaicplot")) updateSelectInput(session, "x", choices = categoricNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$x), input$x, categoricNames(intro.data()))[1]) else updateSelectInput(session, "x", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$x), input$x, numericNames(intro.data())[1]))
        if (input$plottype %in% c("mosaicplot")) updateSelectInput(session, "y", choices = categoricNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$y), input$y, categoricNames(intro.data())[1])) else updateSelectInput(session, "y", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$y), input$y, numericNames(intro.data())[2]))
        updateSelectInput(session, "xreg", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$xreg), input$xreg, numericNames(intro.data())[1]))
        updateSelectInput(session, "yreg", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$yreg), input$yreg, numericNames(intro.data())[2]))
        updateSelectInput(session, "group1", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$group1), input$group1, numericNames(intro.data())[1]))
        updateSelectInput(session, "group2", choices = numericNames(intro.data()), selected = ifelse(checkVariable(intro.data(), input$group2), input$group2, numericNames(intro.data())[2]))
        updateSelectInput(session, "grouping", choices = c("None" = "none", names(intro.data())))
        updateCheckboxGroupInput(session, "tblvars", choices = names(intro.data()))
    })
    
    process_logical <- function(data, x) {
        if (is.null(x)) {
            return(data)
        }

        relevant_cols <- names(data)[nchar(x) > 0]
        my_strs <- strsplit(gsub(",", " , ", x), split = ",")
        new_strs <- my_strs[unlist(lapply(my_strs, length)) > 0]

        new_data <- data
        if (length(new_strs) > 0) {
            for (i in 1:length(new_strs)) {
                test <- new_strs[[i]]
                col <- relevant_cols[i]
                
                subset_str <- ""
                if (length(test) == 1) {
                    if (is.na(as.numeric(test[1]))) {
                        subset_str <- paste0("'", test[1], "' == ", col)
                    } else {
                        subset_str <- paste(test[1], "==", col)
                    }
                } else {
                    test[1] <- ifelse(test[1] == " ", -Inf, test[1])
                    test[2] <- ifelse(test[2] == " ", Inf, test[2])
                    if (is.na(test[2])) test[2] <- Inf
                    
                    subset_str <- paste(test[1], "<=", col, "&", col, "<=", test[2])
                }          
                new_data <- eval(parse(text = paste0("subset(new_data, ", subset_str, ")")))
            }
        }
                
        return(new_data)
    }
    
    mydat <- NULL
    oldval <- 0
    intro.start <- reactive({
        
        #dependency on input$clearssubset
        if (input$clearsubset > oldval) {
            updateCheckboxInput(session, "randomsub", value = FALSE)
            oldval <<- input$clearsubset
        }
      
        data.initial <- data.module(input$data_own, chosen.data(), input$own)
        
        if (values$firstrun) textStorage <<- paste(textStorage, "### ", input$`side-nav`,"\n", paste(c(readLines(paste("modules/", input$`side-nav`, ".R", sep = ""))), collapse = "\n"), "\n\n", sep = "")
        
        if (values$firstrun) {
            updateAceEditor(session, "myEditor", value=textStorage)
            values$firstrun <- FALSE
        }
                
        mydat <<- data.initial
                
        return(data.initial)
    })
    
    oldsaveresid <- 0
    oldsavetrans <- 0
    oldsavesub <- 0
    mydat_rand <- NULL
    
    intro.data <- reactive({
        if (is.null(intro.start())) return(NULL)

        data.subset <- process_logical(mydat, input$subs)
        mydat <<- data.subset
        if (input$randomsub) { 
            mydat_rand <<- dplyr::sample_n(data.subset, input$randomsubrows)
            if (input$savesubset > oldsavesub) {
                mydat <<- mydat_rand
                updateCheckboxInput(session, "randomsub", value = FALSE)
                oldsavesub <<- input$savesubset
            }
        }
        
        if (input$saveresid > oldsaveresid) {
            curxreg <- input$xreg
            curyreg <- input$yreg
            
            if (curxreg %in% names(mydat) & curyreg %in% names(mydat)) {
                mydat <<- savefit(mydat, input$xreg, input$yreg)
            }
            
            oldsaveresid <<- input$saveresid
        }
        
        if (input$savetrans > oldsavetrans) {
            curtrans <- input$var_trans
            
            if (curtrans %in% numericNames(mydat) & input$trans == "power" & !is.na(input$power)) {
                trans_x <- if (input$power == 0) log(mydat[,curtrans]) else (mydat[,curtrans])^(input$power)
                mydat[, paste(curtrans, sub("\\.", "", input$power), sep = "_")] <<- as.numeric(trans_x)                
                updateRadioButtons(session, "trans", selected = "I")
            } else if (curtrans %in% names(mydat) & input$trans == "type") {
                trans_x <- if (input$var_type == "quantitative") as.numeric(mydat[,curtrans]) else factor(mydat[,curtrans])
                mydat[, paste(curtrans, "trans", sep = "_")] <<- trans_x             
                updateRadioButtons(session, "trans", selected = "I")
            }
            
            oldsavetrans <<- input$savetrans
        }
        
        return(mydat)
    })

    observe({
        if (!values$firstrun) {
            new.tab <- input$`side-nav`
            new.str <-  paste("### ", paste(input$`side-nav`, "\n", paste(readLines(paste("modules/", new.tab, ".R", sep = "")), collapse = "\n"), sep = ""), "\n\n", sep = "")
            
            ### Special case for plots
            if (input$`side-nav` == "Graphical") {
                new.str <- paste("### ", paste(new.tab, "\n", input$plottype, " <- ", paste(deparse(get(input$plottype)), collapse = "\n"), sep = ""), "\n\n", sep = "")
            }
            
            text.split <- strsplit(textStorage, "### ")[[1]]
            text.split <- text.split[-(text.split == "")]
            text.ind <- grep(input$`side-nav`, text.split)
            if (length(text.ind) == 0) text.ind <- length(text.split) + 1
            text.split[-text.ind] <- paste("###", text.split[-text.ind])
            text.split[text.ind] <- new.str
            
            textStorage <<- paste(text.split, collapse = "")
            
            updateAceEditor(session, "myEditor", value=textStorage)
        }
    })
    
    output$downloaddata <- downloadHandler(
        filename = function() { paste0("intro_data_", today(), ".csv") },
        content = function(file) {
            write.csv(intro.data(), file)
        }
    )

    q1 <- function(x) { return(quantile(x, .25)) }
    q3 <- function(x) { return(quantile(x, .75)) }

    output$new_summary <- renderPrint({
        if (is.null(input$tblvars)){
            return(NULL)    
        } else if (input$grouping == "none") {
            return(summary(intro.data()[,input$tblvars]))
        } else {
            dat <- intro.data()
            dat$intro_grouping <- dat[,input$grouping]
            
            dat.dplyr <- dat %>% group_by(intro_grouping) %>% summarise_each(funs(min, q1, median, q3, max, mean, sd))
            
            return(dat.dplyr)
        }
    })
    
    chosen.data <- reactive({
        return(valid.datasets[[input$data]])
    })
    
    chosen.plot <- reactive({
        return(valid.plottypes[[input$plottype]])
    })
    
    chosen.bartype <- reactive({
        return(valid.bartypes[[input$bartype]])
    })
    
    dt.options <- reactive({list(pageLength = 10,
                                 searching=0,
                                 destroy=1,
                                 headerCallback =  I(paste0("function(thead, data, start, end, display) {
                                               //color code the header items
                                               var col_types = [", 
                                                            paste(paste0("'", ifelse(grepl("factor", whatis(intro.data())$type), "categorical", ifelse(grepl("character", whatis(intro.data())$type), "categorical", "quantitative")),"'"),
                                                                  collapse=", "),
                                                            "]
                                               var headers = $(thead).find('th');

                                               for(i = 0; i < col_types.length; i++) {
                                                if(col_types[i] == 'categorical') headers[i].style.color = '#e41a1c';
                                                else headers[i].style.color = '#377eb8';
                                               }

                                              if($('.dataTables_length').parent().next().find('span').length == 0) $('.dataTables_length').parent().next().append('<div, style=\"float:right\"><span style=\"color:rgb(228, 26, 28)\">Categorical Variable</span><span style=\"color:rgb(55, 126, 184)\">     Numeric Variable</span></div>')
                                            }")
                                 ))})


    output$data <- renderDataTable({  
      return( intro.data())
    }, options = dt.options)

    output$mosaicplot <- renderPlot({
        return(print(mosaicplot(intro.data(), input$x, input$y)))
    })
    
    output$summary <- renderTable({
        return(summarytable(intro.data(), input$tblvars))
    }, include.rownames = FALSE)
    
    output$regtable <- renderTable({
        if (!(input$xreg %in% numericNames(intro.data())) | !(input$yreg %in% numericNames(intro.data()))) return(NULL)
        else return(tablereg(intro.data(), input$xreg, input$yreg))
    }, digits = 4)
    
    output$r <- renderText({
        if (!(input$xreg %in% numericNames(intro.data())) | !(input$yreg %in% numericNames(intro.data()))) return(NULL)
        else return(r(intro.data(), input$xreg, input$yreg))
    })
    
    output$r2 <- renderText({
        if (!(input$xreg %in% numericNames(intro.data())) | !(input$yreg %in% numericNames(intro.data()))) return(NULL)
        return(r2(intro.data(), input$xreg, input$yreg))
    })
    
    output$ttesttable <- renderText({
        if (!(input$group1 %in% numericNames(intro.data()))) return(NULL)
        return(ttesttable(intro.data(), input$group1, input$group2, input$varts == "twovart", input$conflevel, input$althyp, input$hypval))
    })
})
